---
- name: install app
  hosts: opp_prod
  gather_facts: no
  vars:
    proxy_env:
      http_proxy: "http://192.168.189.195:8080"
      https_proxy: "http://192.168.189.195:8080"
      NO_PROXY: "localhost,127.0.0.1"
    software_src_path: "/usr/opp/download"
    software_dest_path: "/usr/opp/download"
    REDISCLI_AUTH: StrongP@@ssw0rd123!
  tasks:
    - name: ping
      ping:
      tags: ping_hosts
    - name: create software_src_path
      file:
        path: "{{ software_src_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
      tags: create_software_src_path
    - name: create software_dest_path
      ansible.builtin.file:
        path: "{{ software_dest_path }}"
        state: directory
      tags: create_software_dest_path
    - name: setup yum proxy
      blockinfile:
        path: /etc/yum.conf
        block: |
          proxy=http://192.168.189.195:8080
        marker: ""
        backup: yes
        state: present
      tags: setup_yum_proxy
    - name: setup hosts
      blockinfile:
        path: /etc/hosts
        block: |
          160.88.114.70 corprodc02.corp.ha.org.hk
          160.98.39.18 corprodc03.corp.ha.org.hk
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: yes
        state: present
      tags: setup_hosts
    - name: setup resolv.conf
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: '0644'
        backup: yes
        content: |
          options timeout:5 attempts:1
          search     corp.ha.org.hk server.ha.org.hk ha.org.hk

          nameserver 210.87.250.48
          nameserver 210.87.253.13
      tags: setup_resolv_conf
    - name: setup limits
      blockinfile:
        path: /etc/security/limits.conf
        block: |
          * soft nofile 1048576
          * soft nofile 1048576
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: no
        state: present
      tags: setup_limits
    - name: dnf
      dnf:
        name:
          - gcc
          - make
          - openssl
          - openssl-devel
          - zlib
          - zlib-devel
          - perl-devel
          - perl-ExtUtils-Embed
          - net-tools
          - vim
          - wget
          - lrzsz
          - openldap-clients
          - openldap-devel
          - realmd
          - sssd
          - sssd-ldap
          - oddjob-mkhomedir
          - oddjob
          - samba-common-tools
          - sssd-tools
          - chrony
          - krb5-libs
          - krb5-workstation
          - krb5-devel
          - libecap
          - libecap-devel
          - gnutls-devel
          - pam-devel
          - libtdb-devel
          - libxml2-devel
          - gcc
          - gcc-c++
          - pcre
          - pcre-devel
          - gd-devel
          - openssl
          - openssl-devel
          - zlib
          - zlib-devel
          - perl-devel
          - perl-ExtUtils-Embed
          - gd-devel
          - net-tools
          - libxslt-devel
          - libxml2
          - libxslt-devel
          - openldap-clients
          - systemd-devel
          - ftp
          - go
        state: present
      tags: install_dnf_package
###########
#### todo           ####
#### chrony service ####
###########
    - name: add squid account
      ansible.builtin.user:
        name: squid
        shell: /sbin/nologin
        system: yes
        state: present
      tags: add_squid_user
    - name: download squid-6.11
      get_url:
        url: https://www.squid-cache.org/Versions/v6/squid-6.11.tar.gz
        dest: "{{ software_src_path }}/squid-6.11.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_squid_6_11
    - name: copy squid-6.11.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/squid-6.11.tar.gz"
        dest: "{{ software_dest_path }}/squid-6.11.tar.gz"
      tags: copy_squid
    - name: squid-unarchive
      unarchive:
        src: "{{ software_dest_path }}/squid-6.11.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
    - name: squid-configure
      shell: |
        ./configure --prefix=/opt/squid \
            --bindir=/opt/squid/bin \
            --sbindir=/opt/squid/sbin \
            --sysconfdir=/opt/squid/etc \
            --datadir=/opt/squid/share \
            --includedir=/opt/squid/include \
            --libdir=/opt/squid/lib \
            --libexecdir=/opt/squid/libexec \
            --localstatedir=/opt/squid/var \
            --sharedstatedir=/opt/squid/lib \
            --mandir=/opt/squid/share/man \
            --infodir=/opt/squid/share/info \
            --with-logdir=/opt/squid/var/log \
            --with-pidfile=/opt/squid/var/run/squid.pid \
            --enable-ssl \
            --with-openssl=/usr \
            --enable-auth \
            --enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB,SMB_LM \
            --enable-auth-ntlm=SMB_LM,fake \
            --enable-auth-digest=file,LDAP \
            --enable-auth-negotiate=kerberos \
            --enable-external-acl helpers=LDAP_group,time_quota,session,unix_group,wbinfo_group,kerberos_ldap_group \
            --enable-storeid-rewrite-helpers=file \
            --enable-cache-digests \
            --enable-cachemgr-hostname=localhost \
            --enable-delay-pools \
            --enable-epoll \
            --enable-icap-client \
            --enable-ident-lookups \
            --enable-linux-netfilter \
            --enable-removal-policies=heap,lru \
            --enable-snmp \
            --enable-ssl-crtd \
            --enable-storeio=aufs,diskd,ufs,rock \
            --enable-diskio \
            --enable-wccpv2 \
            --enable-esi \
            --enable-ecap \
            --with-aio \
            --with-default-user=squid \
            --enable-async-io \
            --with-dl \
            --with-pthreads \
            --with-swapdir=/opt/squid/var/spool/squid
      args:
        chdir: "{{ software_dest_path }}/squid-6.11"
    - name: squid-compile
      shell: make && make install
      args:
        chdir: "{{ software_dest_path }}/squid-6.11"
        creates: /opt/squid
      tags: squid_compile
    - name: squid-config-init
      blockinfile:
        path: /opt/squid/etc/squid.conf
        block: |
          cache_effective_user squid
          cache_effective_group squid
          cache_dir rock /opt/squid/var/spool/squid 10240 swap-timeout=300
          coredump_dir /opt/squid/var/coredumps
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: yes
        state: present
      tags: squid_config_init
    - name: squid coredumps create
      ansible.builtin.file:
        path: /opt/squid/var/coredumps
        state: directory
        owner: squid
        group: squid
      tags: squid_coredumps_create
    - name: squid dir owner
      ansible.builtin.file:
        path: /opt/squid
        state: directory
        owner: squid
        group: squid
        recurse: yes
      tags: squid_dir_owner
    - name: squid cache dir init
      ansible.builtin.command: /opt/squid/sbin/squid -z
      args:
        creates: /opt/squid/var/spool/squid/rock
      tags: squid_cache_dir_init
    - name: squid service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/squid.service
        owner: root
        group: root
        mode: '0644'
        content: |          
          [Unit]
          Description=Squid Web Proxy Cache
          After=network.target
          
          [Service]
          Type=forking
          User=root
          ExecStart=/opt/squid/sbin/squid -f /opt/squid/etc/squid.conf
          ExecReload=/opt/squid/sbin/squid -k reconfigure -f /opt/squid/etc/squid.conf
          ExecStop=/opt/squid/sbin/squid -k shutdown -f /opt/squid/etc/squid.conf
          PIDFile=/opt/squid/var/run/squid.pid
          LimitNOFILE=1048576
          LimitNPROC=1048576
          LimitCORE=infinity
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: squid_service_create
    - name: squid service start
      ansible.builtin.systemd:
        name: squid
        state: started
        enabled: yes
      tags: squid_service_start
    - name: copy opp keytab
      ansible.builtin.copy:
        src: /opt/squid/etc/opp.keytab
        dest: /opt/squid/etc/opp.keytab
        owner: squid
        group: squid
      tags: copy_opp_keytab
    - name: copy krb5 conf
      ansible.builtin.copy:
        src: /etc/krb5.conf
        dest: /etc/krb5.conf
      tags: copy_krb5_conf
    - name: copy krb5 j2 conf
      ansible.builtin.copy:
        src: /etc/krb5.conf.j2
        dest: /etc/krb5.conf.j2
      tags: copy_krb5_j2_conf
    - name: download headers-more-nginx-module-0.34
      get_url:
        url: https://github.com/openresty/headers-more-nginx-module/archive/refs/tags/v0.34.tar.gz
        dest: "{{ software_src_path }}/headers-more-nginx-module-0.34.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_headers_more_nginx_module_0_34
    - name: copy headers-more-nginx-module.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/headers-more-nginx-module-0.34.tar.gz"
        dest: "{{ software_dest_path }}/headers-more-nginx-module-0.34.tar.gz"
      tags: copy_headers_more_nginx_module
    - name: headers-more-nginx-module-unarchive
      unarchive:
        src: "{{ software_dest_path }}/headers-more-nginx-module-0.34.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: headers_more_nginx_module_unarchive
    - name: download nginx-1.2.5.tar.gz
      get_url:
        url: https://nginx.org/download/nginx-1.25.5.tar.gz
        dest: "{{ software_src_path }}/nginx-1.25.5.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_nginx_1_2_5
    - name: copy nginx-1.2.5.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/nginx-1.25.5.tar.gz"
        dest: "{{ software_dest_path }}/nginx-1.25.5.tar.gz"
      tags: copy_nginx
    - name: nginx-unarchive
      unarchive:
        src: "{{ software_dest_path }}/nginx-1.25.5.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: nginx_unarchive
#    - name: nginx-configure
#      shell: |
#        ./configure --user=nginx --group=nginx --prefix=/usr/nginx \
#            --with-cc-opt=-O2 \
#            --with-http_ssl_module \
#            --with-http_v2_module \
#            --with-http_sub_module \
#            --with-http_stub_status_module \
#            --with-threads \
#            --with-compat \
#            --add-module=../headers-more-nginx-module \
#            --sbin-path=/usr/nginx/sbin/nginx \
#            --conf-path=/usr/nginx/conf/nginx.conf \
#            --with-stream \
#            --without-pcre2 \
#            --with-stream_ssl_module \
#            --with-stream_ssl_preread_module
#      args:
#        chdir: "{{ software_dest_path }}/nginx-1.25.5"
#      tags: nginx_configure
    - name: nginx-configure
      shell: |
        ./configure --user=nginx --group=nginx --prefix=/opt/nginx \
            --with-cc-opt=-O2 \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_sub_module \
            --with-http_stub_status_module \
            --with-threads \
            --with-compat \
            --add-module=../headers-more-nginx-module-0.34 \
            --sbin-path=/opt/nginx/sbin/nginx \
            --conf-path=/opt/nginx/conf/nginx.conf \
            --with-stream \
            --without-pcre2 \
            --with-stream_ssl_module \
            --with-stream_ssl_preread_module
      args:
        chdir: "{{ software_dest_path }}/nginx-1.25.5"
      tags: nginx_configure
#    - name: nginx-compile
#      shell: make && make install
#      args:
#        chdir: "{{ software_dest_path }}/nginx-1.25.5"
#        creates: /usr/nginx
#      tags: nginx_compile
    - name: nginx-compile
      shell: make && make install
      args:
        chdir: "{{ software_dest_path }}/nginx-1.25.5"
      tags: nginx_compile
#    - name: nginx service create
#      ansible.builtin.copy:
#        dest: /etc/systemd/system/nginx.service
#        owner: root
#        group: root
#        mode: '0644'
#        content: |
#          [Unit]
#          Description=The nginx HTTP and reverse proxy server
#          After=network.target remote-fs.target nss-lookup.target
#          
#          [Service]
#          Type=forking
#          PIDFile=/usr/nginx/logs/nginx.pid
#          ExecStartPre=/usr/nginx/sbin/nginx -t
#          ExecStart=/usr/nginx/sbin/nginx
#          ExecReload=/usr/nginx/sbin/nginx -s reload
#          ExecStop=/bin/kill -s QUIT $MAINPID
#          PrivateTmp=true
#          
#          [Install]
#          WantedBy=multi-user.target
#      notify: reload systemd
#      tags: nginx_service_create
    - name: nginx service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/nginx.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=The nginx HTTP and reverse proxy server
          After=network.target remote-fs.target nss-lookup.target
          
          [Service]
          Type=forking
          PIDFile=/opt/nginx/logs/nginx.pid
          ExecStartPre=/opt/nginx/sbin/nginx -t
          ExecStart=/opt/nginx/sbin/nginx
          ExecReload=/opt/nginx/sbin/nginx -s reload
          ExecStop=/bin/kill -s QUIT $MAINPID
          PrivateTmp=true
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: nginx_service_create
    - name: add nginx account
      ansible.builtin.user:
        name: nginx
        shell: /bin/false
        create_home: no
        state: present
        system: yes
      tags: add_nginx_account
    - name: nginx service start init
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: yes
      tags: nginx_service_start_init
    - name: add www-group
      ansible.builtin.group:
        name: www-group
        state: present
      tags: add_www_group
    - name: add nginx to www-group
      ansible.builtin.user:
        name: nginx
        groups: www-group
        append: yes
      tags: add_nginx_www_group
    - name: download epel
      get_url:
        url: https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
        dest: "{{ software_src_path }}/epel-release-latest-8.noarch.rpm"
      delegate_to: localhost
      run_once: true
      tags: download_epel
    - name: copy epel
      ansible.builtin.copy:
        src: "{{ software_src_path }}/epel-release-latest-8.noarch.rpm"
        dest: "{{ software_dest_path }}/epel-release-latest-8.noarch.rpm"
      tags: copy_epel
    - name: download remi
      get_url:
        url: https://rpms.remirepo.net/enterprise/remi-release-8.rpm
        dest: "{{ software_src_path }}/remi-release-8.rpm"
      delegate_to: localhost
      run_once: true
      tags: download_remi
    - name: copy remi
      ansible.builtin.copy:
        src: "{{ software_src_path }}/remi-release-8.rpm"
        dest: "{{ software_dest_path }}/remi-release-8.rpm"
      tags: copy_remi
    - name: install repo
      ansible.builtin.dnf:
        name:
          - https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
          - https://rpms.remirepo.net/enterprise/remi-release-8.rpm
        state: present  
        disable_gpg_check: yes
      environment: "{{ proxy_env }}"
      become: yes
      tags: install_repo
    - name: reset php
      ansible.builtin.dnf:
        name: php
        state: present
      tags: reset_php
    - name: enable php
      ansible.builtin.dnf:
        name: "@php:remi-7.4"
        state: present
      tags: enable_php
    - name: install php dnf
      dnf:
        name:
          - php
          - php-bcmath
          - php-cli
          - php-common
          - php-dba
          - php-dbg
          - php-devel
          - php-embedded
          - php-enchant
          - php-fpm
          - php-gd
          - php-gmp
          - php-intl
          - php-json
          - php-ldap
          - php-mbstring
          - php-mysqlnd
          - php-odbc
          - php-opcache
          - php-pdo
          - php-pear
          - php-pecl-apcu
          - php-pecl-apcu-devel
          - php-pgsql
          - php-process
          - php-recode
          - php-snmp
          - php-soap
          - php-xml
          - php-xmlrpc
          - openssl
          - openldap-clients
          - mod_ssl
          - php-redis
        state: present
      tags: install_dnf_php_package
    - name: change php-fpm user
      ansible.builtin.replace:
        path: /etc/php-fpm.d/www.conf
        regexp: 'user = apache'
        replace: 'user = nginx'
      tags: change_php_fpm_user
    - name: change php-fpm group
      ansible.builtin.replace:
        path: /etc/php-fpm.d/www.conf
        regexp: 'group = apache'
        replace: 'group = nginx'
      tags: change_php_fpm_group
      notify: reload systemd
    - name: php-fpm service start
      ansible.builtin.systemd:
        name: php-fpm
        state: started
        enabled: yes
      tags: php_fpm_service_start
#    - name: download redis-7.4.2
#      get_url:
#        url: https://download.redis.io/releases/redis-7.4.2.tar.gz
#        dest: "{{ software_src_path }}/redis-7.4.2.tar.gz"
#      delegate_to: localhost
#      run_once: true
#      tags: download_redis_7_4_2
#    - name: copy redis-7.4.2.tar.gz
#      ansible.builtin.copy:
#        src: "{{ software_src_path }}/redis-7.4.2.tar.gz"
#        dest: "{{ software_dest_path }}/redis-7.4.2.tar.gz"
#      tags: copy_redis
#    - name: redis-unarchive
#      unarchive:
#        src: "{{ software_dest_path }}/redis-7.4.2.tar.gz"
#        dest: "{{ software_dest_path }}"
#        remote_src: yes
#      tags: redis_unarchive
#    - name: redis server compile
#      shell: make USE_SYSTEMD=yes && make install
#      args:
#        chdir: "{{ software_dest_path }}/redis-7.4.2"
#      tags: redis_server_compile
    - name: download redis-5.0.3
      get_url:
        url: https://download.redis.io/releases/redis-5.0.3.tar.gz
        dest: "{{ software_src_path }}/redis-5.0.3.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_redis_5_0_3
    - name: copy redis-5.0.3.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/redis-5.0.3.tar.gz"
        dest: "{{ software_dest_path }}/redis-5.0.3.tar.gz"
      tags: copy_redis
    - name: redis-unarchive
      unarchive:
        src: "{{ software_dest_path }}/redis-5.0.3.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: redis_unarchive
    - name: redis server compile
      shell: make USE_SYSTEMD=yes && make install
      args:
        chdir: "{{ software_dest_path }}/redis-5.0.3"
      tags: redis_server_compile
    - name: redis service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/redis.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Redis persistent key-value database
          After=network.target
          
          [Service]
          Type=notify
          ExecStart=/usr/local/bin/redis-server /etc/redis.conf
          ExecStop=/usr/local/bin/redis-cli -p 6379 -a StrongP@@ssw0rd123! shutdown
          Restart=always
          User=redis
          Group=redis
          RuntimeDirectory=redis
          RuntimeDirectoryMode=0755
          PIDFile=/run/redis/redis-server.pid
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: redis_service_create
    - name: edit sysctl.conf
      blockinfile:
        path: /etc/sysctl.conf
        block: |
          vm.overcommit_memory = 1
          net.core.somaxconn = 512
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: yes
        state: present
      tags: edit_sysctl_conf
    - name: edit rc.local
      blockinfile:
        path: /etc/rc.local
        block: |
          echo never > /sys/kernel/mm/transparent_hugepage/enabled
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: no
        state: present
      tags: edit_rc_local
    - name: reload sysctl
      shell: sysctl -p
      tags: reload_sysctl
    - name: add redis account
      ansible.builtin.user:
        name: redis
        shell: /bin/false
        create_home: no
        state: present
        system: yes
      tags: add_redis_account
    - name: copy redis config
      ansible.builtin.copy:
        src: "{{ software_dest_path }}/redis-5.0.3/redis.conf"
        dest: /etc/redis.conf
        remote_src: yes
        owner: redis
        group: redis
      tags: copy_redis_config
#    - name: edit redis config bind
#      ansible.builtin.replace:
#        path: /etc/redis.conf
#        regexp: 'bind 127.0.0.1 -::1'
#        replace: 'bind 127.0.0.1'
#      tags: edit_redis_config_bind
#    - name: edit redis config supervised
#      ansible.builtin.replace:
#        path: /etc/redis.conf
#        regexp: '# supervised auto'
#        replace: 'supervised systemd'
#      tags: edit_redis_config_supervised
    - name: edit redis config supervised
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^supervised no'
        replace: 'supervised systemd'
      tags: edit_redis_config_supervised
    - name: edit redis config protected-mode
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^protected-mode yes'
        replace: 'protected-mode no'
      tags: edit_redis_config_protected_mode
    - name: edit redis config dir
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^dir \./'
        replace: 'dir /opt/redis'
      tags: edit_redis_config_dir
    - name: edit redis config requirepass
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^# requirepass foobared'
        replace: 'requirepass StrongP@@ssw0rd123!'
      tags: edit_redis_config_requirepass
    - name: edit redis config logfile
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^logfile ""$'
        replace: 'logfile /var/log/redis/redis.log'
      tags: edit_redis_config_logfile
    - name: edit redis config pidfile
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^pidfile /var/run/redis_6379\.pid'
        replace: 'pidfile /run/redis/redis-server.pid'
      tags: edit_redis_config_pidfile
    - name: create opt redis dir
      ansible.builtin.file:
        path: /opt/redis
        state: directory
        owner: redis
        group: redis
      tags: create_opt_redis_dir
    - name: create var log redis dir
      ansible.builtin.file:
        path: /var/log/redis
        state: directory
        owner: redis
        group: redis
      tags: create_var_log_redis_dir
    - name: local redis save
      ansible.builtin.shell: redis-cli -h 127.0.0.1 -p 6379 SAVE
      delegate_to: localhost
      run_once: true
      tags: local_redis_save
    - name: copy redis data
      ansible.builtin.copy:
        src: /opt/redis/dump.rdb
        dest: /opt/redis/dump.rdb
      tags: copy_redis_data
    - name: redis service restart
      ansible.builtin.systemd:
        name: redis
        state: restarted
        enabled: yes
      tags: redis_service_restart
    - name: sync nginx dist
      ansible.posix.synchronize:
        src: /opt/nginx/html/dist
        dest: /opt/nginx/html/
      tags: sync_nginx_dist
    - name: sync nginx threat
      ansible.posix.synchronize:
        src: /opt/nginx/html/threat
        dest: /opt/nginx/html/
      tags: sync_nginx_threat
    - name: sync nginx transproxy_admin
      ansible.posix.synchronize:
        src: /opt/nginx/html/transproxy_admin
        dest: /opt/nginx/html/
      tags: sync_nginx_transproxy_admin
    - name: edit transproxy env
      ansible.builtin.replace:
        path: /opt/nginx/html/transproxy_admin/.env
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_transproxy_env
    - name: laravel-queue service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/laravel-queue.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Laravel Queue Worker
          After=network.target redis.service  # 若依赖 Redis，需指定

          [Service]
          User=nginx
          Group=nginx
          WorkingDirectory=/opt/nginx/html/transproxy_admin
          ExecStart=/usr/bin/php -d memory_limit=512M artisan queue:work \
                              --tries=3 \
                              --timeout=120
          
          Restart=always
          RestartSec=5
          MemoryLimit=1G
          
          # 环境变量（重要！）
          #Environment="REDIS_HOST=127.0.0.1"
          #Environment="DB_HOST=127.0.0.1"
          #Environment="APP_ENV=production"
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: laravel_queue_service_create
    - name: laravel_queue service start
      ansible.builtin.systemd:
        name: laravel-queue
        state: started
        enabled: yes
      tags: laravel_queue_service_start
    - name: sync nginx conf
      ansible.posix.synchronize:
        src: /opt/nginx/conf
        dest: /opt/nginx/
      tags: sync_nginx_conf
    - name: edit poxmgtprd nginx conf
      ansible.builtin.replace:
        path: /opt/nginx/conf/conf.d/poxmgtprd.server.ha.org.hk.conf
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_poxmgtprd_nginx_conf
    - name: edit transproxy nginx conf
      ansible.builtin.replace:
        path: /opt/nginx/conf/conf.d/transproxy.swd.ha.org.hk.conf
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_transproxy_nginx_conf
    - name: create nginx cache dir
      ansible.builtin.file:
        path: /opt/nginx/nginx_cache/proxy_temp
        state: directory
      tags: create_nginx_cache_dir
    - name: set nginx user group
      ansible.builtin.file:
        path: /opt/nginx
        state: directory
        owner: nginx
        group: www-group
        recurse: yes
      tags: set_nginx_user_group
    - name: nginx service start 2
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: yes
      tags: nginx_service_start_2
    - name: add squid to www-group
      ansible.builtin.user:
        name: squid
        groups: www-group
        append: yes
      tags: add_squid_www_group
    - name: create squid error dir
      ansible.builtin.file:
        path: /opt/squid/share/errors/en
        state: directory
        owner: squid
        group: squid
      tags: create_squid_error_dir
    - name: sync squid etc
      ansible.posix.synchronize:
        src: /opt/squid/etc
        dest: /opt/squid/
      tags: sync_squid_etc
    - name: chmod ldap_password
      ansible.builtin.file:
        path: /opt/squid/etc/ldap_password
        mode: '0600'
      tags: chmod_ldap_password
    - name: chmod opp.keytab
      ansible.builtin.file:
        path: /opt/squid/etc/opp.keytab
        mode: '0600'
      tags: chmod_opp_keytab
    - name: sync squid errors
      ansible.posix.synchronize:
        src: /opt/squid/share/errors/en
        dest: /opt/squid/share/errors
      tags: sync_squid_errors
    - name: sync squid_shell
      ansible.posix.synchronize:
        src: /opt/squid_shell
        dest: /opt/
      tags: sync_squid_shell
    - name: sync py_prod
      ansible.posix.synchronize:
        src: /opt/py_prod
        dest: /opt/
      tags: sync_py_prod
    - name: edit ftp_accesslog
      ansible.builtin.replace:
        path: /opt/squid_shell/ftp_accesslog.sh
        regexp: 'REMOTE_DIR="/logs/FTP/INET_Proxy/poxappprd52a"'
        replace: 'REMOTE_DIR="/logs/FTP/INET_Proxy/{{ custom_hostname }}"'
      tags: edit_ftp_accesslog
    - name: squid parse
      shell: /opt/squid/sbin/squid -k parse -f /opt/squid/etc/squid.conf
      tags: squid_parse
    - name: squid service restart
      ansible.builtin.systemd:
        name: squid
        state: restarted
        enabled: yes
      tags: squid_service_restart
    - name: check squid status
      shell: systemctl status squid
      register: squid_status
      ignore_errors: yes
      tags: check_squid_status
    - name: output squid status
      debug:
        var: squid_status.stdout_lines
      tags: output_squid_status
    - name: copy rsyslog oproxy
      ansible.builtin.copy:
        src: /etc/rsyslog.d/oproxy_log.conf
        dest: /etc/rsyslog.d/oproxy_log.conf
      tags: copy_rsyslog_oproxy
    - name: edit rsyslog oproxy
      ansible.builtin.replace:
        path: /etc/rsyslog.d/oproxy_log.conf
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_rsyslog_oproxy
    - name: rsyslog service restart
      ansible.builtin.systemd:
        name: rsyslog
        state: restarted
        enabled: yes
      tags: rsyslog_service_restart
    - name: delete stats json
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /opt/nginx/html/transproxy_admin/system_usage.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/netstat_status.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/blacklist_summary.json
      tags: delete_stats_json
    - name: install python redis module
      shell: pip3 install jinja2 redis;pip3 install --upgrade pip;/bin/python3 -m pip show redis;chmod -R a+rx /usr/local/lib/python3.6
      environment: "{{ proxy_env }}"
      tags: install_python_redis_module
    - name: copy logrotate squid
      ansible.builtin.copy:
        src: /etc/logrotate.d/squid
        dest: /etc/logrotate.d/squid
      tags: copy_logrotate_squid
    - name: copy logrotate nginx
      ansible.builtin.copy:
        src: /etc/logrotate.d/nginx
        dest: /etc/logrotate.d/nginx
      tags: copy_logrotate_nginx
    - name: copy logrotate python_prod_logs
      ansible.builtin.copy:
        src: /etc/logrotate.d/python_prod_logs
        dest: /etc/logrotate.d/python_prod_logs
      tags: copy_logrotate_python_prod_logs
    - name: opp-crontab create
      ansible.builtin.copy:
        dest: /etc/cron.d/opp-crontab
        owner: root
        group: root
        mode: '0644'
        content: |+	
          SHELL=/bin/bash
          PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

          10 * * * * root bash /opt/squid_shell/resource_monitor_script.sh &>> /opt/squid_shell/logs/resource_monitor_script.log
          15 0 * * * root bash /opt/squid_shell/ftp_accesslog.sh
          0 */8 * * * root truncate -s 0 /opt/squid/var/log/cache.log
          1 */1 * * * root /usr/bin/python3 /opt/squid_shell/hour_monitor.py &>> /opt/squid_shell/logs/nohup_monitor.log
          2 */1 * * * root bash /opt/squid_shell/network_count.sh &>> /opt/squid_shell/logs/network_count.log
          1 */1 * * * root bash /opt/squid_shell/monitor_matchlogs.sh &>> /opt/squid_shell/logs/monitor_matchlogs.log
          1 0 * * * root bash /opt/squid_shell/count_week_ip_url.sh &>> /opt/squid_shell/logs/monitor_week_top.log
          1 0 * * * root bash /opt/squid_shell/count_week_status.sh &>> /opt/squid_shell/logs/count_week_status.log
          1 */1 * * * root bash /opt/squid_shell/count_estab.sh &>> /opt/squid_shell/logs/count_estab.log
          0 1 * * * root /usr/bin/python3 /opt/nginx/html/threat/IOCsApi_csv.py &>> /opt/squid_shell/logs/ioc_script.log
          5 0 * * * root /usr/sbin/logrotate -f /etc/logrotate.d/squid &>> /opt/squid_shell/logs/logrotate.log
          30 0 * * * root /usr/sbin/logrotate -f /etc/logrotate.d/nginx
          45 0 * * * root /usr/sbin/logrotate -f /etc/logrotate.d/python_prod_logs
          0 1 * * * root /usr/bin/curl -k https://127.0.0.1:8000/api/logs_del  &>> /opt/squid_shell/logs/php_logs_del.log
          0 1,13 * * * root /usr/bin/curl -k https://127.0.0.1:8000/api/upredis_dir &>> /opt/squid_shell/logs/php_upredis_dir.log

      tags: opp_crontab_create
    - name: opp sudoer create
      ansible.builtin.copy:
        dest: /etc/sudoers.d/opp
        owner: root
        group: root
        mode: '0440'
        content: |
          ## Allows nginx user to run OPP commond
          nginx ALL=(root) NOPASSWD: /usr/bin/python3 /opt/py_prod/squid_ldap_modify.py
          nginx ALL=(root) NOPASSWD: /usr/bin/python3 /opt/py_prod/squid_kerberos_modify.py
          nginx ALL=(root) NOPASSWD: /opt/squid/sbin/squid -k reconfigure
      tags: opp_sudoer_create
    - name: download node_exporter-1.8.2.linux-amd64.tar.gz
      get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
        dest: "{{ software_src_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_node_exporter_1_8_2
    - name: copy node_exporter
      ansible.builtin.copy:
        src: "{{ software_src_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
        dest: "{{ software_dest_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
      tags: copy_node_exporter
    - name: node exporter unarchive
      unarchive:
        src: "{{ software_dest_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: node_exporter_unarchive
    - name: create node_exporter dir
      ansible.builtin.file:
        path: /usr/local/node_exporter
        state: directory
      tags: create_node_exporter_dir
    - name: copy node_exporter
      ansible.builtin.copy:
        src: "{{ software_dest_path }}/node_exporter-1.8.2.linux-amd64/node_exporter"
        dest: /usr/local/node_exporter/node_exporter
        remote_src: yes
        owner: root
        group: root
        mode: '0755'
      tags: copy_node_exporter
    - name: node_exporter service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/node_exporter.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=node_exporter
          Documentation=https://github.com/prometheus/node_exporter
          After=network.target
          
          [Service]
          Type=simple
          User=root
          ExecStart=/usr/local/node_exporter/node_exporter --web.listen-address=:9100
          Restart=on-failure
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: node_exporter_service_create
    - name: node_exporter service start
      ansible.builtin.systemd:
        name: node_exporter
        state: started
        enabled: yes
      tags: node_exporter_service_start
    - name: check node_exporter status
      shell: systemctl status node_exporter
      register: node_exporter_status
      ignore_errors: yes
      tags: check_node_exporter_status
    - name: output node_exporter status
      debug:
        var: node_exporter_status.stdout_lines
      tags: output_node_exporter_status
    - name: check node_exporter status
      shell: curl http://127.0.0.1:9100/metrics
      tags: check_node_exporter_status
    - name: check nginx ssl crt exists
      delegate_to: localhost
      ansible.builtin.stat:
        path: "{{ software_src_path }}/{{ src_ssl_crt }}"
      register: ssl_crt_file
      run_once: true
      tags: apply_nginx_custom_ssl
    - name: copy nginx ssl crt
      ansible.builtin.copy:
        src: "{{ software_src_path }}/{{ src_ssl_crt }}"
        dest: "/opt/nginx/conf/ssl/{{ custom_hostname }}.crt"
        owner: nginx
        group: www-group
        mode: '0400'
      when: ssl_crt_file.stat.exists | default(false)
      tags: apply_nginx_custom_ssl
    - name: check nginx ssl key exists
      delegate_to: localhost
      ansible.builtin.stat:
        path: "{{ software_src_path }}/{{ src_ssl_key }}"
      register: ssl_key_file
      run_once: true
      tags: apply_nginx_custom_ssl
    - name: copy nginx ssl key
      ansible.builtin.copy:
        src: "{{ software_src_path }}/{{ src_ssl_key }}"
        dest: "/opt/nginx/conf/ssl/{{ custom_hostname }}.key"
        owner: nginx
        group: www-group
        mode: '0400'
      when: ssl_key_file.stat.exists | default(false)
      tags: apply_nginx_custom_ssl
    - name: edit ssl.conf ssl_certificate
      ansible.builtin.replace:
        path: /opt/nginx/conf/ssl/ssl.conf
        regexp: 'ssl_certificate /opt/nginx/conf/ssl/poxappprd52a.crt;'
        replace: 'ssl_certificate /opt/nginx/conf/ssl/{{ custom_hostname }}.crt;'
      tags: apply_nginx_custom_ssl
    - name: edit ssl.conf ssl_certificate_key
      ansible.builtin.replace:
        path: /opt/nginx/conf/ssl/ssl.conf
        regexp: 'ssl_certificate_key /opt/nginx/conf/ssl/poxappprd52a.key;'
        replace: 'ssl_certificate_key /opt/nginx/conf/ssl/{{ custom_hostname }}.key;'
      tags: apply_nginx_custom_ssl
    - name: nginx service ssl start
      ansible.builtin.systemd:
        name: nginx
        state: restarted
        enabled: yes
      tags: apply_nginx_custom_ssl
  handlers:
      - name: reload systemd
        ansible.builtin.systemd:
          daemon_reload: yes