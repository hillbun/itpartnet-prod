---
- name: install app
  hosts: opp_prod
  gather_facts: no
  tasks:
    - name: ping
      ping:
      tags: ping_hosts
    - name: hosts record
      blockinfile:
        path: /etc/hosts
        block: |
          160.88.114.70 corprodc02.corp.ha.org.hk
          160.98.39.18 corprodc03.corp.ha.org.hk
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: yes
        state: present
      register: hosts_result
      tags: setup_hosts
    - name: dnf
      dnf:
        name:
          - gcc
          - make
          - openssl
          - openssl-devel
          - zlib
          - zlib-devel
          - perl-devel
          - perl-ExtUtils-Embed
          - net-tools
          - vim
          - wget
          - lrzsz
          - openldap-clients
          - openldap-devel
          - realmd
          - sssd
          - sssd-ldap
          - oddjob-mkhomedir
          - oddjob
          - samba-common-tools
          - sssd-tools
          - chrony
          - krb5-libs
          - krb5-workstation
          - krb5-devel
          - libecap
          - libecap-devel
          - gnutls-devel
          - pam-devel
          - libtdb-devel
          - libxml2-devel
        state: present
      tags: install_dnf_package
    - name: add squid account
      ansible.builtin.user:
        name: squid
        shell: /sbin/nologin
        system: yes
        state: present
      tags: add_squid_user
    - name: create software dir
      ansible.builtin.file:
        path: /usr/deploy/software
        state: directory
      tags: create_software_dir
    - name: download squid
      ansible.builtin.get_url:
        url: http://www.squid-cache.org/Versions/v6/squid-6.11.tar.gz
        dest: /usr/deploy/software/squid-6.11.tar.gz
      environment:
        GAI_STRATEGY: pf_inet
      tags: download_squid