---
- name: upgrade opp
  hosts: opp_prod
  gather_facts: no
  tasks:
    - name: copy krb5 conf
      ansible.builtin.copy:
        src: /etc/krb5.conf
        dest: /etc/krb5.conf
      tags: copy_krb5_conf
    - name: copy krb5 j2 conf
      ansible.builtin.copy:
        src: /etc/krb5.conf.j2
        dest: /etc/krb5.conf.j2
      tags: copy_krb5_j2_conf
    - name: download headers-more-nginx-module-0.34
      get_url:
        url: https://github.com/openresty/headers-more-nginx-module/archive/refs/tags/v0.34.tar.gz
        dest: "{{ software_src_path }}/headers-more-nginx-module-0.34.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_headers_more_nginx_module_0_34
    - name: copy headers-more-nginx-module.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/headers-more-nginx-module-0.34.tar.gz"
        dest: "{{ software_dest_path }}/headers-more-nginx-module-0.34.tar.gz"
      tags: copy_headers_more_nginx_module
    - name: headers-more-nginx-module-unarchive
      unarchive:
        src: "{{ software_dest_path }}/headers-more-nginx-module-0.34.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: headers_more_nginx_module_unarchive
    - name: download nginx-1.2.5.tar.gz
      get_url:
        url: https://nginx.org/download/nginx-1.25.5.tar.gz
        dest: "{{ software_src_path }}/nginx-1.25.5.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_nginx_1_2_5
    - name: copy nginx-1.2.5.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/nginx-1.25.5.tar.gz"
        dest: "{{ software_dest_path }}/nginx-1.25.5.tar.gz"
      tags: copy_nginx
    - name: nginx-unarchive
      unarchive:
        src: "{{ software_dest_path }}/nginx-1.25.5.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: nginx_unarchive
    - name: add nginx account
      ansible.builtin.user:
        name: nginx
        shell: /bin/false
        create_home: no
        state: present
        system: yes
      tags: add_nginx_account
    - name: add nginx to squid group
      ansible.builtin.user:
        name: nginx
        groups: squid
        append: yes
      tags: add_nginx_squid_group
    - name: nginx service start init
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: yes
      tags: nginx_service_start_init
    - name: add www-group
      ansible.builtin.group:
        name: www-group
        state: present
      tags: add_www_group
    - name: add nginx to www-group
      ansible.builtin.user:
        name: nginx
        groups: www-group
        append: yes
      tags: add_nginx_www_group
    - name: nginx-configure
      shell: |
        ./configure --user=nginx --group=nginx --prefix=/opt/nginx \
            --with-cc-opt=-O2 \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_sub_module \
            --with-http_stub_status_module \
            --with-threads \
            --with-compat \
            --add-module=../headers-more-nginx-module-0.34 \
            --sbin-path=/opt/nginx/sbin/nginx \
            --conf-path=/opt/nginx/conf/nginx.conf \
            --with-stream \
            --without-pcre2 \
            --with-stream_ssl_module \
            --with-stream_ssl_preread_module
      args:
        chdir: "{{ software_dest_path }}/nginx-1.25.5"
      tags: nginx_configure
    - name: nginx-compile
      shell: make && make install
      args:
        chdir: "{{ software_dest_path }}/nginx-1.25.5"
      tags: nginx_compile
    - name: nginx service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/nginx.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=The nginx HTTP and reverse proxy server
          After=network.target remote-fs.target nss-lookup.target
          
          [Service]
          Type=forking
          PIDFile=/opt/nginx/logs/nginx.pid
          ExecStartPre=/opt/nginx/sbin/nginx -t
          ExecStart=/opt/nginx/sbin/nginx
          ExecReload=/opt/nginx/sbin/nginx -s reload
          ExecStop=/bin/kill -s QUIT $MAINPID
          PrivateTmp=true
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: nginx_service_create
    - name: download epel
      get_url:
        url: https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
        dest: "{{ software_src_path }}/epel-release-latest-8.noarch.rpm"
      delegate_to: localhost
      run_once: true
      tags: download_epel
    - name: copy epel
      ansible.builtin.copy:
        src: "{{ software_src_path }}/epel-release-latest-8.noarch.rpm"
        dest: "{{ software_dest_path }}/epel-release-latest-8.noarch.rpm"
      tags: copy_epel
    - name: download remi
      get_url:
        url: https://rpms.remirepo.net/enterprise/remi-release-8.rpm
        dest: "{{ software_src_path }}/remi-release-8.rpm"
      delegate_to: localhost
      run_once: true
      tags: download_remi
    - name: copy remi
      ansible.builtin.copy:
        src: "{{ software_src_path }}/remi-release-8.rpm"
        dest: "{{ software_dest_path }}/remi-release-8.rpm"
      tags: copy_remi
    - name: install repo
      ansible.builtin.dnf:
        name:
          - https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
          - https://rpms.remirepo.net/enterprise/remi-release-8.rpm
        state: present  
        disable_gpg_check: yes
      environment: "{{ proxy_env }}"
      become: yes
      tags: install_repo
    - name: reset php
      ansible.builtin.dnf:
        name: php
        state: present
      tags: reset_php
    - name: enable php
      ansible.builtin.dnf:
        name: "@php:remi-7.4"
        state: present
      tags: enable_php
    - name: install php dnf
      dnf:
        name:
          - php
          - php-bcmath
          - php-cli
          - php-common
          - php-dba
          - php-dbg
          - php-devel
          - php-embedded
          - php-enchant
          - php-fpm
          - php-gd
          - php-gmp
          - php-intl
          - php-json
          - php-ldap
          - php-mbstring
          - php-mysqlnd
          - php-odbc
          - php-opcache
          - php-pdo
          - php-pear
          - php-pecl-apcu
          - php-pecl-apcu-devel
          - php-pgsql
          - php-process
          - php-recode
          - php-snmp
          - php-soap
          - php-xml
          - php-xmlrpc
          - openssl
          - openldap-clients
          - mod_ssl
          - php-redis
        state: present
      tags: install_dnf_php_package
    - name: change php-fpm user
      ansible.builtin.replace:
        path: /etc/php-fpm.d/www.conf
        regexp: 'user = apache'
        replace: 'user = nginx'
      tags: change_php_fpm_user
    - name: change php-fpm group
      ansible.builtin.replace:
        path: /etc/php-fpm.d/www.conf
        regexp: 'group = apache'
        replace: 'group = nginx'
      tags: change_php_fpm_group
      notify: reload systemd
    - name: php-fpm service start
      ansible.builtin.systemd:
        name: php-fpm
        state: started
        enabled: yes
      tags: php_fpm_service_start
    - name: download redis-5.0.3
      get_url:
        url: https://download.redis.io/releases/redis-5.0.3.tar.gz
        dest: "{{ software_src_path }}/redis-5.0.3.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_redis_5_0_3
    - name: copy redis-5.0.3.tar.gz
      ansible.builtin.copy:
        src: "{{ software_src_path }}/redis-5.0.3.tar.gz"
        dest: "{{ software_dest_path }}/redis-5.0.3.tar.gz"
      tags: copy_redis
    - name: redis-unarchive
      unarchive:
        src: "{{ software_dest_path }}/redis-5.0.3.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: redis_unarchive
    - name: redis server compile
      shell: make USE_SYSTEMD=yes && make install
      args:
        chdir: "{{ software_dest_path }}/redis-5.0.3"
      tags: redis_server_compile
    - name: redis service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/redis.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Redis persistent key-value database
          After=network.target
          
          [Service]
          Type=notify
          ExecStart=/usr/local/bin/redis-server /etc/redis.conf
          ExecStop=/usr/local/bin/redis-cli -p 6379 -a StrongP@@ssw0rd123! shutdown
          Restart=always
          User=redis
          Group=redis
          RuntimeDirectory=redis
          RuntimeDirectoryMode=0755
          PIDFile=/run/redis/redis-server.pid
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: redis_service_create
    - name: edit sysctl.conf
      blockinfile:
        path: /etc/sysctl.conf
        block: |
          vm.overcommit_memory = 1
          net.core.somaxconn = 512
          net.ipv4.icmp_echo_ignore_all = 0
          fs.file-max = 1000000
          net.ipv4.tcp_max_tw_buckets = 2000000
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: yes
        state: present
      tags: edit_sysctl_conf
    - name: edit sysctl.conf ip_local_port_range
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        regexp: '^#?net\.ipv4\.ip_local_port_range'
        line: 'net.ipv4.ip_local_port_range = 1024 65535'
        state: present
      tags: edit_sysctl_conf_ip_local_port_range
    - name: reload sysctl
      shell: sysctl -p
      tags: reload_sysctl
    - name: edit rc.local
      blockinfile:
        path: /etc/rc.local
        block: |
          echo never > /sys/kernel/mm/transparent_hugepage/enabled
        marker: "#### {mark} ADDED BY OPP INSTALLATION ####"
        backup: no
        state: present
      tags: edit_rc_local
    - name: add redis account
      ansible.builtin.user:
        name: redis
        shell: /bin/false
        create_home: no
        state: present
        system: yes
      tags: add_redis_account
    - name: copy redis config
      ansible.builtin.copy:
        src: "{{ software_dest_path }}/redis-5.0.3/redis.conf"
        dest: /etc/redis.conf
        remote_src: yes
        owner: redis
        group: redis
      tags: copy_redis_config
    - name: edit redis config supervised
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^supervised no'
        replace: 'supervised systemd'
      tags: edit_redis_config_supervised
    - name: edit redis config protected-mode
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^protected-mode yes'
        replace: 'protected-mode no'
      tags: edit_redis_config_protected_mode
    - name: edit redis config dir
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^dir \./'
        replace: 'dir /opt/redis'
      tags: edit_redis_config_dir
    - name: edit redis config requirepass
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^# requirepass foobared'
        replace: 'requirepass StrongP@@ssw0rd123!'
      tags: edit_redis_config_requirepass
    - name: edit redis config logfile
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^logfile ""$'
        replace: 'logfile /var/log/redis/redis.log'
      tags: edit_redis_config_logfile
    - name: edit redis config pidfile
      ansible.builtin.replace:
        path: /etc/redis.conf
        regexp: '^pidfile /var/run/redis_6379\.pid'
        replace: 'pidfile /run/redis/redis-server.pid'
      tags: edit_redis_config_pidfile
    - name: create opt redis dir
      ansible.builtin.file:
        path: /opt/redis
        state: directory
        owner: redis
        group: redis
      tags: create_opt_redis_dir
    - name: create redis_bak dir
      become: yes
      ansible.builtin.file:
        path: /opt/redis_bak
        state: directory
        owner: redis
        group: redis
        mode: '0755'
      tags: create_redis_bak_dir
    - name: create var log redis dir
      ansible.builtin.file:
        path: /var/log/redis
        state: directory
        owner: redis
        group: redis
      tags: create_var_log_redis_dir
    - name: local redis save
      ansible.builtin.shell: redis-cli -h 127.0.0.1 -p 6379 SAVE
      delegate_to: localhost
      run_once: true
      tags: local_redis_save
    - name: copy redis data
      ansible.builtin.copy:
        src: /opt/redis/dump.rdb
        dest: /opt/redis/dump.rdb
      tags: copy_redis_data
    - name: redis service restart
      ansible.builtin.systemd:
        name: redis
        state: restarted
        enabled: yes
      tags: redis_service_restart
    - name: sync nginx dist
      ansible.posix.synchronize:
        src: /opt/nginx/html/dist
        dest: /opt/nginx/html/
      tags: sync_nginx_dist
    - name: sync nginx threat
      ansible.posix.synchronize:
        src: /opt/nginx/html/threat
        dest: /opt/nginx/html/
      tags: sync_nginx_threat
    - name: sync nginx transproxy_admin
      ansible.posix.synchronize:
        src: /opt/nginx/html/transproxy_admin
        dest: /opt/nginx/html/
      tags: sync_nginx_transproxy_admin
    - name: create fileData_bak dir
      become: yes
      ansible.builtin.file:
        path: /opt/fileData_bak
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'
      tags: create_filedata_bak_dir
    - name: edit transproxy env
      ansible.builtin.replace:
        path: /opt/nginx/html/transproxy_admin/.env
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_transproxy_env
    - name: laravel-queue service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/laravel-queue.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=Laravel Queue Worker
          After=network.target redis.service  # 若依赖 Redis，需指定

          [Service]
          User=nginx
          Group=nginx
          WorkingDirectory=/opt/nginx/html/transproxy_admin
          ExecStart=/usr/bin/php -d memory_limit=512M artisan queue:work \
                              --tries=3 \
                              --timeout=120
          
          Restart=always
          RestartSec=5
          MemoryLimit=1G
          
          # 环境变量（重要！）
          #Environment="REDIS_HOST=127.0.0.1"
          #Environment="DB_HOST=127.0.0.1"
          #Environment="APP_ENV=production"
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: laravel_queue_service_create
    - name: laravel_queue service start
      ansible.builtin.systemd:
        name: laravel-queue
        state: started
        enabled: yes
      tags: laravel_queue_service_start
    - name: sync nginx conf
      ansible.posix.synchronize:
        src: /opt/nginx/conf
        dest: /opt/nginx/
      tags: sync_nginx_conf
    - name: edit poxmgtprd nginx conf
      ansible.builtin.replace:
        path: /opt/nginx/conf/conf.d/poxmgtprd.server.ha.org.hk.conf
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_poxmgtprd_nginx_conf
    - name: edit transproxy nginx conf
      ansible.builtin.replace:
        path: /opt/nginx/conf/conf.d/transproxy.swd.ha.org.hk.conf
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_transproxy_nginx_conf
    - name: create nginx cache dir
      ansible.builtin.file:
        path: /opt/nginx/nginx_cache/proxy_temp
        state: directory
      tags: create_nginx_cache_dir
    - name: set nginx user group
      ansible.builtin.file:
        path: /opt/nginx
        state: directory
        owner: nginx
        group: www-group
        recurse: yes
      tags: set_nginx_user_group
    - name: nginx service start 2
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: yes
      tags: nginx_service_start_2
    - name: add squid to www-group
      ansible.builtin.user:
        name: squid
        groups: www-group
        append: yes
      tags: add_squid_www_group
    - name: create squid error dir
      ansible.builtin.file:
        path: /opt/squid/share/errors/en
        state: directory
        owner: squid
        group: squid
      tags: create_squid_error_dir
    - name: sync squid etc
      ansible.posix.synchronize:
        src: /opt/squid/etc
        dest: /opt/squid/
      tags: sync_squid_etc
    - name: chmod ldap_password
      ansible.builtin.file:
        path: /opt/squid/etc/ldap_password
        mode: '0600'
      tags: chmod_ldap_password
    - name: chmod opp.keytab
      ansible.builtin.file:
        path: /opt/squid/etc/opp.keytab
        mode: '0600'
      tags: chmod_opp_keytab
    - name: sync squid errors
      ansible.posix.synchronize:
        src: /opt/squid/share/errors/en
        dest: /opt/squid/share/errors
      tags: sync_squid_errors
    - name: sync squid_shell
      ansible.posix.synchronize:
        src: /opt/squid_shell
        dest: /opt/
      tags: sync_squid_shell
    - name: sync py_prod
      ansible.posix.synchronize:
        src: /opt/py_prod
        dest: /opt/
      tags: sync_py_prod
    - name: edit ftp_accesslog
      ansible.builtin.replace:
        path: /opt/squid_shell/ftp_accesslog.sh
        regexp: 'REMOTE_DIR="/logs/FTP/INET_Proxy/poxappprd52a"'
        replace: 'REMOTE_DIR="/logs/FTP/INET_Proxy/{{ custom_hostname }}"'
      tags: edit_ftp_accesslog
    - name: squid parse
      shell: /opt/squid/sbin/squid -k parse -f /opt/squid/etc/squid.conf
      tags: squid_parse
    - name: squid service restart
      ansible.builtin.systemd:
        name: squid
        state: restarted
        enabled: yes
      tags: squid_service_restart
    - name: check squid status
      shell: systemctl status squid
      register: squid_status
      ignore_errors: yes
      tags: check_squid_status
    - name: output squid status
      debug:
        var: squid_status.stdout_lines
      tags: output_squid_status
    - name: copy rsyslog oproxy
      become: yes
      ansible.builtin.copy:
        src: /etc/rsyslog.d/oproxy_log.conf
        dest: /etc/rsyslog.d/oproxy_log.conf
      tags: copy_rsyslog_oproxy
    - name: edit rsyslog oproxy
      become: yes
      ansible.builtin.replace:
        path: /etc/rsyslog.d/oproxy_log.conf
        regexp: 'poxappprd52a'
        replace: '{{ custom_hostname }}'
      tags: edit_rsyslog_oproxy
    - name: rsyslog service restart
      ansible.builtin.systemd:
        name: rsyslog
        state: restarted
        enabled: yes
      tags: rsyslog_service_restart
    - name: delete stats json
      become: yes
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /opt/nginx/html/transproxy_admin/system_usage.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/netstat_status.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/blacklist_summary.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/week_top_ip_10.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/week_top_url_10.json
        - /opt/nginx/html/transproxy_admin/public/fileData/threat/logstatus_7days.json
        - /tmp/usage.json.tmp
      tags: delete_stats_json
    - name: copy logrotate squid
      ansible.builtin.copy:
        src: /etc/logrotate.d/squid
        dest: /etc/logrotate.d/squid
      tags: copy_logrotate_squid
    - name: copy logrotate nginx
      ansible.builtin.copy:
        src: /etc/logrotate.d/nginx
        dest: /etc/logrotate.d/nginx
      tags: copy_logrotate_nginx
    - name: copy logrotate python_prod_logs
      ansible.builtin.copy:
        src: /etc/logrotate.d/python_prod_logs
        dest: /etc/logrotate.d/python_prod_logs
      tags: copy_logrotate_python_prod_logs
    - name: create account logreader
      ansible.builtin.user:
        name: logreader
        state: present
        shell: /bin/bash
        create_home: yes
        groups: squid,www-group
        append: yes
        password: "{{ 'logreader_password' | password_hash('sha512') }}"
      tags: create_account_logreader
    - name: set logreader key
      become: yes
      ansible.builtin.authorized_key:
        user: logreader
        state: present
        key: "{{ lookup('file', '~logreader/.ssh/id_rsa.pub') }}"
      tags: set_logreader_key
    - name: create opp sudoer
      become: yes
      ansible.builtin.template:
        src: templates/sudoer-opp.j2
        dest: /etc/sudoers.d/opp
        owner: root
        group: root
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'
      tags: create_opp_sudoer
    - name: chown squid_shell
      become: yes
      ansible.builtin.file:
        path: /opt/squid_shell
        state: directory
        owner: logreader
        group: logreader
        mode: '0755'
        recurse: yes
      tags: chown_squid_shell
    - name: create logrotate dir
      become: yes
      ansible.builtin.file:
        path: /opt/logrotate
        state: directory
        owner: logreader
        group: logreader
        mode: '0755'
      tags: create_logrotate_dir
    - name: create logrotate config
      become: yes
      become_user: logreader
      block:
        - name: logrotate sub dir
          ansible.builtin.file:
            path: "/opt/logrotate/{{ item }}"
            state: directory
          loop:
            - "etc"
            - "status"
        - name: logrotate config squid
          ansible.builtin.template:
            src: templates/logrotate_config_squid.j2
            dest: /opt/logrotate/etc/squid
          vars:
            access_log_path: "/opt/squid/var/log/access.log"
            cache_log_path: "/opt/squid/var/log/cache.log"
            access_tianji_blacklist_log_path: "/opt/squid/var/log/access-tianji-blacklist.log"
            squid_path: "/opt/squid"
        - name: logrotate config nginx
          ansible.builtin.template:
            src: templates/logrotate_config_nginx.j2
            dest: /opt/logrotate/etc/nginx
          vars:
            log_path: "/opt/nginx/logs/*.log"
            nginx_path: "/opt/nginx"
        - name: logrotate config python_prod_logs
          ansible.builtin.template:
            src: templates/logrotate_config_python_prod_logs.j2
            dest: /opt/logrotate/etc/python_prod_logs
          vars:
            log_path: "/opt/py_prod/log/*.log"
      tags: create_logrotate_config
    - name: create opp-crontab dir
      become: yes
      ansible.builtin.file:
        path: /opt/crontab
        state: directory
        owner: logreader
        group: logreader
        mode: '0755'
      tags: create_opp_crontab_dir
    - name: opp-crontab config
      become: yes
      become_user: logreader
      block:
        - name: create opp-crontab
          ansible.builtin.template:
            src: templates/opp-crontab.j2
            dest: /opt/crontab/opp-crontab
        - name: run opp-crontab
          ansible.builtin.shell:
            cmd: "crontab /opt/crontab/opp-crontab"
      tags: opp_crontab_config
    - name: chmod crontab file attribute
      become: yes
      file:
        path: "{{ item }}"
        mode: "g+w"
      loop:
        - /opt/squid/var/log
        - /opt/squid/var/log/cache.log
        - /opt/nginx/html/transproxy_admin
        - /opt/nginx/html/transproxy_admin/storage/logs
        #- /opt/nginx/html/transproxy_admin/storage/temp
        - /opt/nginx/html/transproxy_admin/public/fileData/threat
        - /opt/nginx/html/threat/archive
      tags: chmod_crontab_file_attribute
    - name: download node_exporter-1.8.2.linux-amd64.tar.gz
      get_url:
        url: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
        dest: "{{ software_src_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
      delegate_to: localhost
      run_once: true
      tags: download_node_exporter_1_8_2
    - name: copy node_exporter
      ansible.builtin.copy:
        src: "{{ software_src_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
        dest: "{{ software_dest_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
      tags: copy_node_exporter
    - name: node exporter unarchive
      unarchive:
        src: "{{ software_dest_path }}/node_exporter-1.8.2.linux-amd64.tar.gz"
        dest: "{{ software_dest_path }}"
        remote_src: yes
      tags: node_exporter_unarchive
    - name: create node_exporter dir
      ansible.builtin.file:
        path: /usr/local/node_exporter
        state: directory
      tags: create_node_exporter_dir
    - name: copy node_exporter
      ansible.builtin.copy:
        src: "{{ software_dest_path }}/node_exporter-1.8.2.linux-amd64/node_exporter"
        dest: /usr/local/node_exporter/node_exporter
        remote_src: yes
        owner: root
        group: root
        mode: '0755'
      tags: copy_node_exporter
    - name: node_exporter service create
      ansible.builtin.copy:
        dest: /etc/systemd/system/node_exporter.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=node_exporter
          Documentation=https://github.com/prometheus/node_exporter
          After=network.target
          
          [Service]
          Type=simple
          User=root
          ExecStart=/usr/local/node_exporter/node_exporter --web.listen-address=:9100
          Restart=on-failure
          
          [Install]
          WantedBy=multi-user.target
      notify: reload systemd
      tags: node_exporter_service_create
    - name: node_exporter service start
      ansible.builtin.systemd:
        name: node_exporter
        state: started
        enabled: yes
      tags: node_exporter_service_start
    - name: check node_exporter status
      shell: systemctl status node_exporter
      register: node_exporter_status
      ignore_errors: yes
      tags: check_node_exporter_status
    - name: output node_exporter status
      debug:
        var: node_exporter_status.stdout_lines
      tags: output_node_exporter_status
    - name: check node_exporter status
      shell: curl http://127.0.0.1:9100/metrics
      tags: check_node_exporter_status