---
- name: upgrade opp
  hosts: opp_prod
  gather_facts: no
  vars_files:
    - vars/app_vars.yml
  tasks:
    - name: upgrade py_prod
      become: yes
      tags: upgrade_py_prod
      block:
        - name: backup py_prod
          ansible.posix.synchronize:
            src: /opt/py_prod/
            dest: "/opt/backup/py_prod_{{ current_time }}/"
            archive: yes
            rsync_opts:
              - "--owner"
              - "--group"
              - "--numeric-ids"
          delegate_to: "{{ inventory_hostname }}"
    - name: sync py_prod
      ansible.posix.synchronize:
        src: /opt/py_prod/
        dest: /opt/py_prod/
        archive: yes
        delete: yes
      rsync_opts:
        - "--exclude=log/"