ss -ant 返回了以下结果

State      Recv-Q Send-Q   Local Address:Port     Peer Address:Port Process
LISTEN     0      128            0.0.0.0:111           0.0.0.0:*
LISTEN     0      128            0.0.0.0:8080          0.0.0.0:*
LISTEN     0      128            0.0.0.0:80            0.0.0.0:*
LISTEN     0      128            0.0.0.0:8081          0.0.0.0:*
LISTEN     0      128            0.0.0.0:22            0.0.0.0:*
LISTEN     0      100          127.0.0.1:25            0.0.0.0:*
LISTEN     0      128            0.0.0.0:443           0.0.0.0:*
LISTEN     0      128            0.0.0.0:8000          0.0.0.0:*
LISTEN     0      128            0.0.0.0:6379          0.0.0.0:*
LISTEN     0      128            0.0.0.0:9100          0.0.0.0:*
ESTAB      0      0      192.168.152.103:8080       11.68.63.9:58109
ESTAB      0      0            127.0.0.1:6379        127.0.0.1:16934
TIME-WAIT  0      0      192.168.152.103:46416  52.168.117.175:443
ESTAB      0      0      192.168.152.103:44456    20.59.87.225:443
ESTAB      0      0            127.0.0.1:6379        127.0.0.1:17510
TIME-WAIT  0      0      192.168.152.103:53694   40.126.35.128:443
ESTAB      0      0      192.168.152.103:8080      160.5.51.25:60461
ESTAB      0      0            127.0.0.1:9522        127.0.0.1:49615
ESTAB      0      0            127.0.0.1:28274       127.0.0.1:6379
ESTAB      0      0            127.0.0.1:19640       127.0.0.1:26857
ESTAB      0      0      192.168.152.103:10938    20.59.87.225:443
ESTAB      0      0      192.168.152.103:8080     160.5.42.148:50360
ESTAB      0      0      192.168.152.103:43844     4.145.79.81:443
ESTAB      0      0      192.168.152.103:8080     160.11.17.25:58084
ESTAB      0      0            127.0.0.1:61659       127.0.0.1:35354
ESTAB      0      0      192.168.152.103:8080     160.5.92.108:51443
ESTAB      0      0      192.168.152.103:42852   163.70.158.60:443
ESTAB      0      0            127.0.0.1:31412       127.0.0.1:6379
TIME-WAIT  0      0      192.168.152.103:5170     20.99.185.48:443
ESTAB      0      0            127.0.0.1:17360       127.0.0.1:6379
ESTAB      0      0            127.0.0.1:27796       127.0.0.1:6379
ESTAB      0      0      192.168.152.103:19150     4.145.79.81:443
ESTAB      0      0            127.0.0.1:28154       127.0.0.1:6379
ESTAB      0      0      192.168.152.103:47106  142.250.197.98:443
ESTAB      0      0            127.0.0.1:5612        127.0.0.1:28045
ESTAB      0      0            127.0.0.1:18163       127.0.0.1:42318
ESTAB      0      0            127.0.0.1:15952       127.0.0.1:6379
ESTAB      0      0      192.168.152.103:64086     4.145.79.80:443
TIME-WAIT  0      0      192.168.152.103:10006  135.233.95.144:443
ESTAB      0      0      192.168.152.103:12038  157.240.199.60:5222
ESTAB      0      0      192.168.152.103:42922     4.145.79.81:443
ESTAB      0      0      192.168.152.103:8080     160.11.17.85:53377
ESTAB      0      0      192.168.152.103:8080     160.5.95.181:57290
ESTAB      0      0      192.168.152.103:5502      4.145.79.82:443
ESTAB      0      0      192.168.152.103:8080     160.43.21.27:49975
ESTAB      0      0      192.168.152.103:45750    20.59.87.225:443
ESTAB      0      0      192.168.152.103:14974   64.236.28.130:443
ESTAB      0      0            127.0.0.1:6379        127.0.0.1:17206
ESTAB      0      0      192.168.152.103:8080    160.44.91.130:53762
ESTAB      0      0            127.0.0.1:51393       127.0.0.1:11952
FIN-WAIT-2 0      0      192.168.152.103:8080     160.43.92.71:60993
ESTAB      0      0            127.0.0.1:6537        127.0.0.1:52640
ESTAB      0      0            127.0.0.1:30294       127.0.0.1:6379
ESTAB      0      0      192.168.152.103:42902     4.145.79.81:443
ESTAB      0      0            127.0.0.1:56624       127.0.0.1:34241
ESTAB      0      0            127.0.0.1:16969       127.0.0.1:15812
ESTAB      0      0            127.0.0.1:58173       127.0.0.1:44088
ESTAB      0      0            127.0.0.1:6379        127.0.0.1:15754
ESTAB      0      0            127.0.0.1:46442       127.0.0.1:11247
ESTAB      0      0            127.0.0.1:29248       127.0.0.1:6379
ESTAB      0      0            127.0.0.1:32951       127.0.0.1:54704
ESTAB      0      0      192.168.152.103:8080      160.19.76.9:64388
ESTAB      0      0            127.0.0.1:16244       127.0.0.1:6379
ESTAB      0      0      192.168.152.103:10850  157.240.199.60:5222
ESTAB      0      0            127.0.0.1:20278       127.0.0.1:57807
ESTAB      0      0            127.0.0.1:6746        127.0.0.1:41383
ESTAB      0      0            127.0.0.1:8214        127.0.0.1:49577
ESTAB      0      0      192.168.152.103:43126     4.145.79.81:443
ESTAB      0      0            127.0.0.1:45147       127.0.0.1:38718
ESTAB      0      0      192.168.152.103:42302   20.15.141.193:443
ESTAB      0      0      192.168.152.103:8080      160.5.60.87:51140
ESTAB      0      0      192.168.152.103:8080      160.5.64.42:51739
ESTAB      0      0      192.168.152.103:27056 142.250.198.202:443
ESTAB      0      0            127.0.0.1:15848       127.0.0.1:6853
ESTAB      0      0            127.0.0.1:36095       127.0.0.1:9902
ESTAB      0      0      192.168.152.103:46570   52.207.122.56:443
ESTAB      0      0      192.168.152.103:8080     160.19.114.5:49409
ESTAB      0      0      192.168.152.103:8080      160.5.51.10:58899
ESTAB      0      0      192.168.152.103:41796     4.145.79.81:443
ESTAB      0      0            127.0.0.1:12456       127.0.0.1:47619
ESTAB      0      0      192.168.152.103:18450     4.145.79.81:443
ESTAB      0      0      192.168.152.103:8080    160.22.40.101:52254

请用一条ss命令，过滤出状态不是LISTEN，Local Address:Port中的Local Address不是127.0.0.1, Port不是8080的所有记录
ss -ant | awk '$1 != "LISTEN" && $4 !~ /^127\.0\.0\.1:/ && $4 !~ /:8080$/'

---
请用一条ss命令，过滤出状态不是LISTEN，Local Address:Port中的Local Address不是127.0.0.1, Port大于1024而且不是8080的所有记录
ss -ant | awk '$1 != "LISTEN" && $4 !~ /^127\.0\.0\.1:/ && $4 !~ /:8080$/ && match($4, /:([0-9]+)$/, a) && a[1] > 1024'

ss -ant | awk '$1 != "LISTEN" && $4 !~ /^127\.0\.0\.1:/ && $4 !~ /:8080$/ && match($4, /:([0-9]+)$/, a) && a[1] > 1024' | wc -l

#!/bin/bash

# 当前非监听、高端口 TCP 连接数
conn_count=$(ss -ant | awk '$1 != "LISTEN" && $4 !~ /^127\.0\.0\.1:/ && $4 !~ /:8080$/ && match($4, /:([0-9]+)$/, a) && a[1] > 1024' | wc -l)

# iptables 规则标记
RULE_EXISTS=$(iptables -C INPUT -p tcp --dport 8080 -j REJECT 2>/dev/null)

# 阈值
THRESHOLD=100

if [ "$conn_count" -ge "$THRESHOLD" ]; then
    # 超过阈值，添加阻止规则（如果没添加过）
    if [ -z "$RULE_EXISTS" ]; then
        iptables -I INPUT -p tcp --dport 8080 -j REJECT
        echo "$(date): 连接数 $conn_count ≥ $THRESHOLD，已阻止外部访问 8080"
    fi
else
    # 低于阈值，删除阻止规则（如果存在）
    if [ -n "$RULE_EXISTS" ]; then
        iptables -D INPUT -p tcp --dport 8080 -j REJECT
        echo "$(date): 连接数 $conn_count < $THRESHOLD，已恢复 8080 访问"
    fi
fi


---

#!/bin/bash

# 当前非监听、高端口 TCP 连接数
conn_count=$(ss -ant | awk '$1 != "LISTEN" && $4 !~ /^127\.0\.0\.1:/ && $4 !~ /:8080$/ && match($4, /:([0-9]+)$/, a) && a[1] > 1024' | wc -l)

# 检查iptables规则是否存在
iptables -C INPUT -p tcp --dport 8080 -j REJECT &>/dev/null
# 根据返回值判断规则是否存在
if [ $? -eq 0 ]; then
    RULE_EXISTS=1
else
    RULE_EXISTS=0
fi

# 阈值
THRESHOLD=100

echo '1 - ' . $conn_count
echo '2 - ' . $RULE_EXISTS
echo '3 - ' . $THRESHOLD

if [ "$conn_count" -ge "$THRESHOLD" ]; then
    # 超过阈值，添加阻止规则（如果没添加过）
    if [ $RULE_EXISTS -eq 0 ]; then
	    echo "4"
        iptables -I INPUT -p tcp --dport 8080 -j REJECT
        #echo "$(date): 连接数 $conn_count ≥ $THRESHOLD，已阻止外部访问 8080"
    else
	    echo "5"
	fi
else
    # 低于阈值，删除阻止规则（如果存在）
    if [ $RULE_EXISTS -eq 1 ]; then
	    echo "6"
        iptables -D INPUT -p tcp --dport 8080 -j REJECT
        #echo "$(date): 连接数 $conn_count < $THRESHOLD，已恢复 8080 访问"
    fi
    else
	    echo "7"
	fi
fi




if [ $RULE_EXISTS -eq 0 ]; then
    iptables -I INPUT -p tcp --dport 8080 -j REJECT
    echo "$(date): 连接数 $conn_count ≥ $THRESHOLD，已阻止外部访问 8080"
else
    # 在这里添加else分支要执行的代码
    echo "$(date): 连接数 $conn_count ≥ $THRESHOLD，但规则已存在，无需重复添加"
fi

